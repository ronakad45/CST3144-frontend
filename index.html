<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Lessons</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> After School Lessons</h1>
            <div class="header-controls">
                <input v-model="searchQuery" type="text" placeholder="Search lessons." class="search-box">
                <button class="cart-button" v-on:click="changePages" :disabled="cart.length === 0 && !showCart">
                    <i class="fas fa-shopping-cart"></i>
                    Cart
                    <span v-if="cart.length > 0" class="cart-badge">{{ cartItemCount }}</span>
                </button>
            </div>
        </div>


        <div v-if="!showCart">
            <div class="sort-controls">
                <label>Sort by:</label>
                <select v-model="sortAttributes">
                    <option value="subject">Subject</option>
                    <option value="location">Location</option>
                    <option value="price">Price</option>
                    <option value="spaces">Availability</option>
                </select>
                
                <label>Order:</label>
                <select v-model="sortOrders">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <div class="lessons-grid">
                <div v-for="lesson in sortedLessons" :key="lesson._id" class="lesson-card">
                    <div class="lesson-icon">
                        <i :class="lesson.icon"></i>
                    </div>
                    <h3>{{ lesson.subject }}</h3>
                    <div class="lesson-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ lesson.location }}</span>
                    </div>
                    <div class="price">AED {{ lesson.price }}</div>
                    <div class="rating">
                        <i class="fas fa-star star" v-for="n in lesson.rating" :key="n"></i>
                        <i class="far fa-star star" v-for="n in (5 - lesson.rating)" :key="n + 10"></i>
                        ({{ lesson.rating }}/5)
                    </div>
                    <div class="lesson-info spaces">
                        <i class="fas fa-users"></i>
                        <span>{{ lesson.spaces }} spaces available</span>
                    </div>
                    <button class="add-to-cart-btn" v-on:click="addToCart(lesson)" :disabled="lesson.spaces === 0">
                        <i class="fas fa-cart-plus"></i> 
                        {{ lesson.spaces === 0 ? 'Sold Out' : 'Add to Cart' }}
                    </button>
                </div>
            </div>
        </div>

        <div v-else class="cart-page">
            <h2><i class="fas fa-shopping-cart"></i> Shopping Cart</h2>

            <div v-if="cart.length === 0" class="empty-cart">
                <i class="fas fa-shopping-basket" style="font-size: 30px; margin-bottom: 15px;"></i>
                <p>Your Cart looks empty</p>
            </div>

            <div v-else>
                <div v-for="item in cart" :key="item._id" class="cart-item">
                    <div class="cart-item-info">
                        <h4>{{ item.subject }}</h4>
                        <p>{{ item.location }} - AED {{ item.price }}</p>
                        <p>Quantity: {{ item.quantity }}</p>
                    </div>
                    <button class="remove-btn" v-on:click="removeFromCart(item)">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>

                <div class="total-amount">
                    Total: AED {{totalPrice}}
                </div>
                
                <div class="checkout-section">
                    <h3>Checkout</h3>
                    <div v-if="!orderConfirmed">
                        <div class="form-group">
                            <label>Full Name (letters only):</label>
                            <input v-model="order.customerName" type="text" placeholder="Enter your name":class="{ valid: isNameValid, invalid: order.customerName && !isNameValid }">
                            <label>Phone Number (numbers only):</label>
                            <input v-model="order.customerPhone" type="text" placeholder="Enter your phone number":class="{ valid: isPhoneValid, invalid: order.customerPhone && !isPhoneValid }">
                    
                            <label>Address:</label>
                            <input v-model="order.address" type="text" placeholder="Enter your address">
                            <label>City:</label>
                            <input v-model="order.city" type="text" placeholder="Enter city">

                            <label>Emirate:</label>
                            <select v-model="order.emirate">
                                <option disabled value="">Select Emirate</option>
                                <option>Dubai</option>
                                <option>Abu Dhabi</option>
                                <option>Sharjah</option>
                                <option>Fujairah</option>
                            </select>
                    
                            <label>Postal Code:</label>
                            <input v-model="order.zip" type="text" placeholder="Enter postal code">

                            <div>
                                <input type="checkbox" id="gift" v-model="order.gift">
                                <label for="gift" style="display: inline;">Ship As Gift?</label>
                            </div>

                        </div>
                        <button class="checkout-btn" v-on:click="checkout":disabled="!isCheckoutEnabled || submittingOrder">
                            <i class="fas fa-check-circle"></i> 
                            {{submittingOrder ? 'Processing...' : 'Complete Order'}}
                        </button>
                    </div>
                    <div v-if="orderConfirmed" class="confirmation-message">
                        <i class="fas fa-check-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h2>Order Successfully Submitted!</h2>
                        <p>Thank you for your purchase!</p>
                    
                        <div class="order-summary">
                            <h3>Order Information</h3>
                        
                            <h4 style="margin-top: 15px;">Items Ordered:</h4>
                            <div v-for="item in confirmedCart" :key="item._id" class="order-item">
                                {{ item.subject }} - {{ item.location }} (Qty: {{ item.quantity }}) - AED {{ item.price * item.quantity }}
                            </div>
                        
                            <div style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-size: 18px;">
                                <strong>Total: AED {{ confirmedTotal }}</strong>
                            </div>
                        </div>
                        <button class="checkout-btn" v-on:click="startNewOrder" style="margin-top: 15px;">
                            <i class="fas fa-home"></i> Continue Shopping
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    let afterSchool = new Vue({
        el: '#app',
        data: {
            sitename: "After School lessons ",
            lessons: [],
            cart: [],
            showCart: false,
            searchQuery: '',
            sortAttributes: 'subject', // will sort by 'subject' by default
            sortOrders: 'asc', //will sort by ascending by default
            order: {
                customerName: '',
                customerPhone: '',
                address: '',
                city: '',
                zip: '',
                emirate: '',
                gift: false
            },
            orderConfirmed: false,
            confirmedOrder: {},
            confirmedCart: [],
            confirmedTotal: 0,
            submittingOrder: false
        },
        mounted(){
            this.fetchLessons();
        },
        computed:{
            sortedLessons() {
                const lessons = [...this.lessons]; // this takes filtered + sorted list
                
                lessons.sort((a, b) => {
                    let aVal = a[this.sortAttributes];
                    let bVal = b[this.sortAttributes];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (this.sortOrders === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            
                return lessons;
            },

            cartItemCount() {
                return this.cart.reduce((total, item) => total + item.quantity, 0);
            },
            totalPrice() {
                return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            },
            isNameValid() {
                return /^[A-Za-z\s]+$/.test(this.order.customerName) && this.order.customerName.trim().length > 0;
            },
            isPhoneValid() {
                return /^[0-9]+$/.test(this.order.customerPhone) && this.order.customerPhone.length > 0;
            },
            isCheckoutEnabled() {
                return this.isNameValid && 
                        this.isPhoneValid && 
                        this.order.address.trim() && 
                        this.order.city.trim() && 
                        this.order.emirate && 
                        this.order.zip.trim() && 
                        this.cart.length > 0;
            }
        },
        watch:{
            searchQuery(newQuery){
                this.fetchLessons(newQuery);
            }
        },
        
        methods: {
            //fetch all lessons from backend
            async fetchLessons(query = '') {
                try {
                    let url = 'https://cst3144-ronak-after-school-backend-1.onrender.com';

                    // If statement if there is a search query, call /search, otherwise call /lessons
                    if (query && query.trim() !== '') {
                        const encoded = encodeURIComponent(query.trim());
                        url += `/search?q=${encoded}`;
                    } else {
                        url += '/lessons';
                    }

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch lessons');
                    }

                    this.lessons = await response.json();
                    console.log('Lessons loaded:', this.lessons.length);
                } catch (error) {
                    console.error('Error fetching lessons:', error);
                    this.error = 'Failed to load lessons. Please refresh the page.';
                }
            },
            addToCart(lesson) {
                if (lesson.spaces > 0) {
                    const cartItem = this.cart.find(item => item._id === lesson._id);
                    if (cartItem) {
                        cartItem.quantity++;
                    } else {
                        this.cart.push({
                            _id: lesson._id,
                            subject: lesson.subject,
                            location: lesson.location,
                            price: lesson.price,
                            quantity: 1
                        });
                    }
                    
                    lesson.spaces--;
                }
            },
            removeFromCart(item) {
                const lesson = this.lessons.find(l => l._id === item._id);
                if (lesson) {
                    lesson.spaces += item.quantity;
                }
                const index = this.cart.findIndex(i => i._id === item._id);
                if (index > -1) {
                    this.cart.splice(index, 1);
                }
            },
            changePages() {
                this.showCart = !this.showCart;
            },
            async checkout() {
                if (!this.isCheckoutEnabled || this.submittingOrder) {
                    return;
                }
                try{
                    this.submittingOrder = true;

                    const orderData = {
                        customerName: this.order.customerName,
                        customerPhone: this.order.customerPhone,
                        address: this.order.address,
                        city: this.order.city,
                        emirate: this.order.emirate,
                        zip: this.order.zip,
                        gift: this.order.gift,
                        items: this.cart,
                        totalAmount: this.totalPrice
                    };

                    //save order
                    const saveOrderResp = await fetch('https://cst3144-ronak-after-school-backend-1.onrender.com/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(orderData)
                    });

                    if (!saveOrderResp.ok){
                        throw new Error('Failed to submit order');
                    }

                    const orderResult = await saveOrderResp.json();
                    console.log('Order Submitted:', orderResult);
                    // Update lesson spaces in backend
                    for (let item of this.cart) {
                        const lesson = this.lessons.find(l => l._id === item._id);
                        if (lesson) {
                            await this.updateLessonSpaces(item._id, lesson.spaces);
                        }
                    }

                    //show confirmation
                    this.confirmedOrder = JSON.parse(JSON.stringify(this.order));
                    this.confirmedCart = JSON.parse(JSON.stringify(this.cart));
                    this.confirmedTotal = this.totalPrice;
                    this.orderId = orderResult.orderId;
                    this.orderConfirmed = true;

                }catch (error){
                    console.error('Error during Checkout:', error);
                    this.error = 'Failed to submit order. Please try again';
                }finally{
                    this.submittingOrder = false;
                }
            },
            
            async updateLessonSpaces(lessonId, newSpaces) {
                try {
                    const response = await fetch(`https://cst3144-ronak-after-school-backend-1.onrender.com/lessons/${lessonId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ spaces: newSpaces })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update lesson spaces');
                    }
                    
                    const result = await response.json();
                    console.log('Lesson updated:', result);
                } catch (error) {
                    console.error('Error updating lesson:', error);
                }
            },
            startNewOrder() {
                this.cart = [];
                this.confirmedCart = [];
                this.confirmedTotal = 0;
                this.order = {
                    customerName: '',
                    customerPhone: '',
                    address: '',
                    city: '',
                    zip: '',
                    emirate: '',
                    gift: false,
                };
                this.confirmedOrder = {};
                this.orderConfirmed = false;
                this.orderId = '';
                this.showCart = false;

                //reload lessons to get updated spaces
                this.fetchLessons();
            }
        }
    });
</script>
</body>
</html>